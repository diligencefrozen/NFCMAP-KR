<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì• í”Œí˜ì´ ê°€ë§¹ì  ì°¾ê¸°</title>
  <link rel="stylesheet" href="styles.css" />
  <meta name="color-scheme" content="light" />
  <!-- Kakao Maps JS (services + clusterer) -->
  <script defer src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=417a1b970f5ba6f44fd53958e58f47bb&libraries=services,clusterer"></script>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar" role="banner">
    <div class="brand">ì• í”Œí˜ì´ ê°€ë§¹ì  ì°¾ê¸°</div>
    <div class="search-box" role="search">
      <input id="search" placeholder="ìƒí˜¸/ë¸Œëœë“œ ê²€ìƒ‰ (ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤, GS25)" aria-label="ê²€ìƒ‰ì–´" />
      <button id="search-submit" aria-label="ê²€ìƒ‰">ğŸ”</button>
    </div>
    <div class="actions">
      <button id="btn-geoloc" title="ë‚´ ìœ„ì¹˜" aria-label="ë‚´ ìœ„ì¹˜">ğŸ“</button>
      <button id="btn-scan" title="í˜„ì¬ í™”ë©´ ì¬ìŠ¤ìº”" aria-label="í˜„ì¬ í™”ë©´ ì¬ìŠ¤ìº”">ğŸ§­</button>
      <button id="btn-add" title="ê°€ë§¹ì  ì œë³´(GitHub)" aria-label="ê°€ë§¹ì  ì œë³´">â•</button>
      <button id="btn-center" title="ì›ì£¼ í„°ë¯¸ë„ë¡œ" aria-label="ì›ì£¼ í„°ë¯¸ë„ë¡œ">ğŸ¯</button>
    </div>
  </div>

  <!-- ë¸Œëœë“œ í•„í„°(ì• í”Œí˜ì´ ì§€ì› ê°€ì •ëœ ë¸Œëœë“œë§Œ ë…¸ì¶œ) -->
  <div class="chipbar" role="group" aria-label="ë¸Œëœë“œ í•„í„°">
    <label class="chip active" data-brand="gs25"><input type="checkbox" checked>ğŸ›’ GS25</label>
    <label class="chip active" data-brand="starbucks"><input type="checkbox" checked>â˜• ìŠ¤íƒ€ë²…ìŠ¤</label>
    <!-- ì˜ˆ) CUë¥¼ ì¶”ê°€í•˜ë ¤ë©´:
    <label class="chip active" data-brand="cu"><input type="checkbox" checked>ğŸ›’ CU</label>
    -->
  </div>

  <!-- ì§€ë„ -->
  <div id="map" role="region" aria-label="Myapplepaymaps"></div>

  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite"></div>

  <script>
  // =========================
  // Config
  // =========================
  const CFG = {
    OWNER: 'diligencefrozen',
    REPO:  'NFCMAP-KR',
    ISSUE_LABEL: 'add-merchant',
    CENTER: { lat: 37.345040, lng: 127.930825 }, // ì›ì£¼ì¢…í•©ë²„ìŠ¤í„°ë¯¸ë„
    INIT_LEVEL: 5,       // ì¹´ì¹´ì˜¤ ë ˆë²¨(ë‚®ì„ìˆ˜ë¡ í™•ëŒ€)
    MAX_PAGES: 3,        // Places í•œ ë²ˆì— 15ê°œ â†’ ìµœëŒ€ 45ê°œ/ë¸Œëœë“œ/ìŠ¤ìº”
    DEBOUNCE_MS: 600
  };

  // â€œì• í”Œí˜ì´ ì§€ì›â€ìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ í‘œì‹œí•  ë¸Œëœë“œë§Œ ì •ì˜
  const APPLE_BRANDS = [
    { id:'gs25',      label:'í¸ì˜ì ', icon:'ğŸ›’', keywords:['GS25','ì§€ì—ìŠ¤25','GS 25'] },
    { id:'starbucks', label:'ì¹´í˜',   icon:'â˜•', keywords:['ìŠ¤íƒ€ë²…ìŠ¤','Starbucks'] }
    // { id:'cu', label:'í¸ì˜ì ', icon:'ğŸ›’', keywords:['CU','ì”¨ìœ '] }
  ];

  // ì¹´ì¹´ì˜¤ ì¹´í…Œê³ ë¦¬ ì½”ë“œ ë§¤í•‘(ê²€ìƒ‰ íš¨ìœ¨ â†‘)
  // í¸ì˜ì : CS2, ì¹´í˜: CE7
  const BRAND_CATEGORY = {
    gs25: 'CS2',
    starbucks: 'CE7'
    // cu: 'CS2'
  };

  // =========================
  // State
  // =========================
  let map, ps, clusterer, infowindow;
  let allMarkers = [];            // í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì— ì˜¬ë¦´ ë§ˆì»¤ ëª©ë¡
  let debounceTimer = null;
  const activeBrands = new Set(APPLE_BRANDS.map(b=>b.id)); // chip ì²´í¬ëœ ë¸Œëœë“œ

  // =========================
  // Utils
  // =========================
  const $  = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
  const esc = (s='') => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));

  function toast(msg){
    const el = $('#toast'); if(!el) return;
    el.textContent = msg; el.classList.add('show');
    clearTimeout(el._t); el._t = setTimeout(()=> el.classList.remove('show'), 1800);
  }

  // ê²°ê³¼ì—ì„œ ì§€ì • ë¸Œëœë“œì¸ì§€ ìµœì¢… íŒì •(ì´ë¦„ í‚¤ì›Œë“œ ë§¤ì¹­)
  function brandOf(place){
    const name = (place.place_name||'');
    for(const b of APPLE_BRANDS){
      if(b.keywords.some(k=> name.toLowerCase().includes(k.toLowerCase()))) return b;
    }
    return null;
  }

  function buildPopupHTML(place, br){
    const addr  = place.road_address_name || place.address_name || '';
    const tel   = place.phone || '';
    const url   = place.place_url || '';
    const parts = [];
    parts.push(`<div class="title">${esc(place.place_name||'ìƒí˜¸ëª…')}</div>`);
    if(addr) parts.push(`<div class="row">ì£¼ì†Œ: ${esc(addr)}</div>`);
    if(tel)  parts.push(`<div class="row">ì „í™”: <a href="tel:${esc(tel)}">${esc(tel)}</a></div>`);
    parts.push(`<div class="row">ì• í”Œí˜ì´: <b>ì§€ì›(ë¸Œëœë“œ ì§€ì •)</b></div>`);
    parts.push(`<div class="row">ë¶„ë¥˜: ${esc(br.label)}</div>`);
    if(url)  parts.push(`<div class="row"><a href="${esc(url)}" target="_blank" rel="noopener">ìƒì„¸ ë³´ê¸°</a></div>`);
    return `<div class="popup">${parts.join('')}</div>`;
  }

  function createMarker(place, br){
    const pos = new kakao.maps.LatLng(+place.y, +place.x);
    const marker = new kakao.maps.Marker({ position: pos, title: place.place_name });
    kakao.maps.event.addListener(marker, 'click', ()=>{
      const html = buildPopupHTML(place, br);
      infowindow.setContent(html);
      infowindow.open(map, marker);
    });
    marker.__brand = br;
    marker.__place = place;
    return marker;
  }

  function setMarkersToCluster(markers){
    clusterer.clear();
    clusterer.addMarkers(markers);
  }

  function filterMarkersByText(q){
    const qq = (q||'').trim().toLowerCase();
    const filtered = !qq ? allMarkers : allMarkers.filter(m=>{
      const p = m.__place;
      const hay = `${p.place_name||''} ${p.road_address_name||''} ${p.address_name||''} ${p.phone||''}`.toLowerCase();
      return hay.includes(qq);
    });
    setMarkersToCluster(filtered);
    toast(`í‘œì‹œë¨: ${filtered.length}ê³³`);
  }

  function openIssueWith(lat, lng){
    const base = `https://github.com/${encodeURIComponent(CFG.OWNER)}/${encodeURIComponent(CFG.REPO)}/issues/new`;
    const params = new URLSearchParams();
    params.set('title', '[Add] Apple Pay Merchant');
    params.set('labels', CFG.ISSUE_LABEL);
    const body = [
      '**ìƒí˜¸ëª…**\n',
      '**ì¹´í…Œê³ ë¦¬**\nconv / cafe / resto / mart / bakery / pharmacy / transport / other\n',
      '**ìœ„ë„/ê²½ë„**\n', `lat: ${lat}\nlon: ${lng}\n`,
      '**ì• í”Œí˜ì´** (í•´ë‹¹ì— ì²´í¬)\n', '- [ ] Contactless\n- [ ] In-App\n- [ ] Express\n',
      '**ë¹„ê³ /ì¶œì²˜(ì„ íƒ)**\n'
    ].join('\n');
    params.set('body', body);
    window.open(`${base}?${params.toString()}`, '_blank');
  }

  // =========================
  // Kakao Places: ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰(í˜ì´ì§€ ìˆœíšŒ)
  // =========================
  function categorySearchOnce(groupCode, bounds, page=1){
    return new Promise((resolve,reject)=>{
      ps.categorySearch(groupCode, (data, status, pagination)=>{
        if(status === kakao.maps.services.Status.OK){
          resolve({ data, pagination });
        }else if(status === kakao.maps.services.Status.ZERO_RESULT){
          resolve({ data:[], pagination:null });
        }else{
          reject(new Error('Places error: '+status));
        }
      }, { bounds, page });
    });
  }

  async function searchCategoryInBounds(groupCode, bounds){
    const results = [];
    for(let page=1; page<=CFG.MAX_PAGES; page++){
      try{
        const { data } = await categorySearchOnce(groupCode, bounds, page);
        results.push(...data);
        if(data.length < 15) break; // ë‹¤ìŒ í˜ì´ì§€ ì—†ìŒ
      }catch(e){ break; }
    }
    return results;
  }

  // =========================
  // ìŠ¤ìº”: í™”ë©´(BBox) ì•ˆì—ì„œ ì¹´í…Œê³ ë¦¬ â†’ ë¸Œëœë“œ í•„í„°
  // =========================
  async function scanInView(){
    if(!map) return;

    // ë„ˆë¬´ ë„“ìœ¼ë©´ API 45ê°œ ì œí•œìœ¼ë¡œ ëˆ„ë½ â†‘
    if(map.getLevel() > 7){ toast('ì§€ë„ë¥¼ ì¡°ê¸ˆ ë” í™•ëŒ€í•´ ì£¼ì„¸ìš”'); return; }

    toast('ê°€ë§¹ì  ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
    const bounds = map.getBounds();
    const uniq = new Map(); // place idë¡œ ì¤‘ë³µ ì œê±°

    // í™œì„±í™”ëœ ë¸Œëœë“œë§Œ
    const brandIds   = Array.from(activeBrands);
    const brandSpecs = APPLE_BRANDS.filter(b=> brandIds.includes(b.id));

    for(const spec of brandSpecs){
      const code = BRAND_CATEGORY[spec.id];
      if(!code) continue;

      // í™”ë©´ ë‚´ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ì‹¹ ê¸ê¸°
      const list = await searchCategoryInBounds(code, bounds);

      for(const p of list){
        const lat = +p.y, lng = +p.x;
        if(!isFinite(lat) || !isFinite(lng)) continue;
        if(!bounds.contain(new kakao.maps.LatLng(lat, lng))) continue;

        // ì´ë¦„ í‚¤ì›Œë“œë¡œ ìµœì¢… ë¸Œëœë“œ í•„í„°
        const br = brandOf(p);
        if(!br) continue;

        if(!uniq.has(p.id)) uniq.set(p.id, { place: p, br });
      }
    }

    // ë§ˆì»¤ ìƒì„± & í´ëŸ¬ìŠ¤í„° ê°±ì‹ 
    const rows = Array.from(uniq.values());
    allMarkers = rows.map(({ place, br }) => createMarker(place, br));
    setMarkersToCluster(allMarkers);
    toast(`í‘œì‹œë¨: ${allMarkers.length}ê³³`);
  }

  function scheduleScan(){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(scanInView, CFG.DEBOUNCE_MS);
  }

  // =========================
  // Init
  // =========================
  window.addEventListener('DOMContentLoaded', ()=>{
    // ë§µ
    map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(CFG.CENTER.lat, CFG.CENTER.lng),
      level: CFG.INIT_LEVEL
    });

    ps = new kakao.maps.services.Places(map);
    infowindow = new kakao.maps.InfoWindow({ zIndex: 2 });
    clusterer = new kakao.maps.MarkerClusterer({
      map, averageCenter:true, minLevel:6
    });

    // ì§€ë„ ì´ë™/í™•ëŒ€ ì‹œ ìë™ ìŠ¤ìº”(ë””ë°”ìš´ìŠ¤)
    kakao.maps.event.addListener(map, 'idle', scheduleScan);

    // ì§€ì˜¤ë¡œì¼€ì´ì…˜ â†’ ìŠ¤ìº”
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const { latitude, longitude } = pos.coords;
        map.setCenter(new kakao.maps.LatLng(latitude, longitude));
        map.setLevel(4);
        scanInView();
      }, ()=>{
        scanInView();
      }, { enableHighAccuracy:true, timeout:8000, maximumAge:30000 });
    }else{
      scanInView();
    }

    // ë²„íŠ¼ë“¤
    $('#btn-geoloc').addEventListener('click', ()=>{
      if(!navigator.geolocation){ toast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”'); return; }
      navigator.geolocat
