<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ì• í”Œí˜ì´ ê°€ë§¹ì  ì°¾ê¸°</title>
  <link rel="stylesheet" href="styles.css" />
  <meta name="color-scheme" content="light" />
  <!-- Kakao Maps JS (services + clusterer) - autoload=false ë¡œë“œ í›„ kakao.maps.load(init) -->
  <script defer src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=417a1b970f5ba6f44fd53958e58f47bb&libraries=services,clusterer&autoload=false"></script>

  <style>
    .quota-banner{
      position:fixed; z-index:601;
      left:50%; transform:translateX(-50%);
      top:calc(env(safe-area-inset-top,0px) + 110px);
      background:#fee2e2; color:#991b1b; border:1px solid #fecaca;
      border-radius:.6rem; padding:.5rem .75rem; box-shadow:0 2px 10px rgba(0,0,0,.06);
      display:flex; align-items:center; gap:.6rem;
    }
    .quota-banner button{
      border:1px solid #fecaca; background:#fff; border-radius:999px; padding:.25rem .6rem; cursor:pointer;
    }
    @media (max-width:600px){
      .quota-banner{ top:calc(env(safe-area-inset-top,0px)+128px); left:8px; right:8px; transform:none; justify-content:space-between; }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar" role="banner">
    <div class="brand">ğŸ—ºï¸</div>
    <div class="search-box" role="search">
      <input id="search" placeholder="ìƒí˜¸/ë¸Œëœë“œ ê²€ìƒ‰ (ì˜ˆ: ë§¥ë„ë‚ ë“œ ì›ì£¼ ë‹¨ê³„ DTì  )" aria-label="ê²€ìƒ‰ì–´" />
      <button id="search-submit" aria-label="ê²€ìƒ‰">ğŸ”</button>
    </div>
    <div class="actions">
      <button id="btn-geoloc" title="ë‚´ ìœ„ì¹˜" aria-label="ë‚´ ìœ„ì¹˜">ğŸ“</button>
      <button id="btn-scan" title="í˜„ì¬ í™”ë©´ ì¬ìŠ¤ìº”" aria-label="í˜„ì¬ í™”ë©´ ì¬ìŠ¤ìº”">ğŸ§­</button>
      <button id="btn-add" title="ê°€ë§¹ì  ì œë³´(GitHub)" aria-label="ê°€ë§¹ì  ì œë³´">â•</button>
      <button id="btn-center" title="ì›ì£¼ í„°ë¯¸ë„ë¡œ" aria-label="ì›ì£¼ í„°ë¯¸ë„ë¡œ">ğŸ¯</button>
    </div>
  </div>

  <!-- ë¸Œëœë“œ í•„í„°(ë‹¨ì¼ ì„ íƒ ëª¨ë“œ) -->
  <div class="chipbar" role="radiogroup" aria-label="ë¸Œëœë“œ í•„í„°">
    <!-- ì²˜ìŒì— í¸ì˜ì ë§Œ ì„ íƒ -->
    <label class="chip active" data-brand="cstore"><input type="checkbox" checked>ğŸª í¸ì˜ì </label>
    <label class="chip" data-brand="cafe"><input type="checkbox">â˜• ì¹´í˜</label>
    <label class="chip" data-brand="dstore"><input type="checkbox">ğŸ›ï¸ ë°±í™”ì Â·ì‡¼í•‘</label>
    <label class="chip" data-brand="mart"><input type="checkbox">ğŸ›’ ë§ˆíŠ¸Â·ìŠˆí¼</label>
    <label class="chip" data-brand="life"><input type="checkbox">ğŸ”Œ ìƒí™œÂ·ê°€ì „</label>
    <label class="chip" data-brand="fashion"><input type="checkbox">ğŸ‘— íŒ¨ì…˜Â·ë·°í‹°</label>
    <label class="chip" data-brand="dessert"><input type="checkbox">ğŸ° ì œê³¼Â·ë””ì €íŠ¸</label>
    <label class="chip" data-brand="food"><input type="checkbox">ğŸ½ï¸ ì™¸ì‹</label>
    <label class="chip" data-brand="hotel"><input type="checkbox">ğŸ¨ í˜¸í…”Â·ë¦¬ì¡°íŠ¸</label>
    <label class="chip" data-brand="gstation"><input type="checkbox">â›½ ì£¼ìœ Â·ì¶©ì „</label>
    <label class="chip" data-brand="movie"><input type="checkbox">ğŸ¬ ì˜í™”Â·ë„ì„œ</label>
    <label class="chip" data-brand="travel"><input type="checkbox">ğŸ§³ ë ˆì €Â·ì—¬í–‰</label>
  </div>

  <!-- ì§€ë„ -->
  <div id="map" role="region" aria-label="Myapplepaymaps"></div>

  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite"></div>

  <!-- Quota ì•ˆë‚´ ë°°ë„ˆ -->
  <div id="quota-banner" class="quota-banner" role="alert" aria-live="assertive" hidden>
    <span>ì¹´ì¹´ì˜¤ ì§€ë„ API ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆì„ ìˆ˜ ìˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</span>
    <button id="quota-retry" type="button">ë‹¤ì‹œ ì‹œë„</button>
  </div>

  <script>
  // =========================
  // Config
  // =========================
  const CFG = {
    OWNER: 'diligencefrozen',
    REPO:  'NFCMAP-KR',
    ISSUE_LABEL: 'add-merchant',
    CENTER: { lat: 37.345040, lng: 127.930825 }, // ì›ì£¼ì¢…í•©ë²„ìŠ¤í„°ë¯¸ë„
    INIT_LEVEL: 5,       // ì¹´ì¹´ì˜¤ ë ˆë²¨(ë‚®ì„ìˆ˜ë¡ í™•ëŒ€)
    MAX_PAGES: 3,        // Places í•œ ë²ˆì— 15ê°œ â†’ ìµœëŒ€ 45ê°œ/ìŠ¤ìº”
    DEBOUNCE_MS: 600
  };

  // ì¹´í…Œê³ ë¦¬ ì‚¬ì „
  const APPLE_BRANDS = [
    { id:'cstore', label:'í¸ì˜ì ', icon:'ğŸª', keywords:['GS25','CU','ì„¸ë¸ì¼ë ˆë¸','ì´ë§ˆíŠ¸24','ë¯¸ë‹ˆìŠ¤í†±','ìŠ¤í† ë¦¬ì›¨ì´','ì”¨ìŠ¤í˜ì´ìŠ¤24'] },
    { id:'cafe', label:'ì¹´í˜',   icon:'â˜•', keywords:['ìŠ¤íƒ€ë²…ìŠ¤','íˆ¬ì¸í”Œë ˆì´ìŠ¤','ë¹½ë‹¤ë°©','ë©”ê°€ì»¤í”¼','ì´ë””ì•¼ì»¤í”¼','ë”ë²¤í‹°','í• ë¦¬ìŠ¤','ê³µì°¨',
                                                   'ì»¤í”¼ë¹ˆ','ì—”ì œë¦¬ë„ˆìŠ¤','í´ë°”ì…‹','íŒŒìŠ¤ì¿ ì°Œ','ë¸”ë£¨ë³´í‹€','íƒì•¤íƒìŠ¤','ì•„ë§ˆìŠ¤ë¹ˆ','ì»¤í”¼ë² ì´',
                                                   'í…Œë¼ë¡œì‚¬','ì ë°”ì£¼ìŠ¤','ì»¤í”¼ì•³ì›ìŠ¤','ì¹´í˜ìŠ¤í† ë¦¬ì›¨ì´','ì•„í‹°ì œ','ëŒ„ì‹±ì»µ','íŒ€í™€íŠ¼',
                                                   'ì»´í¬ì¦ˆì»¤í”¼','ì¹´í˜ê¼¼ë§ˆ','í•˜ì´ì˜¤ì»¤í”¼','ì¹´í˜ë´„ë´„'] },
    { id:'dstore', label:'ë°±í™”ì Â·ì‡¼í•‘', icon:'ğŸ›ï¸', keywords:['ë¡¯ë°ë°±í™”ì ','ë¡¯ë°ì•„ìš¸ë ›','ë¡¯ë°ëª°','ë¡¯ë°ë©´ì„¸ì ','í˜„ëŒ€ë°±í™”ì ','í˜„ëŒ€ì•„ìš¸ë ›',
                                                       'í˜„ëŒ€ë°±í™”ì ë©´ì„¸ì ','AKí”Œë¼ì','íŒŒë¥´ë‚˜ìŠ¤ëª°','ì•„ì´íŒŒí¬ëª°','ì•¨ë¦¬ì›¨ì´',
                                                       'ì‹ ë¼ë©´ì„¸ì ','JDCë©´ì„¸ì ','ìŠ¤íƒ€í•„ë“œ','ê°¤ëŸ¬ë¦¬ì•„','ì‹ ì„¸ê³„ë©´ì„¸ì '] },
    { id:'mart', label:'ë§ˆíŠ¸Â·ìŠˆí¼', icon:'ğŸ›’', keywords:['ì½”ìŠ¤íŠ¸ì½”ì½”ë¦¬ì•„','ë¡¯ë°ë§ˆíŠ¸','ë¡¯ë°ìŠˆí¼','í™ˆí”ŒëŸ¬ìŠ¤ë§ˆíŠ¸','í™ˆí”ŒëŸ¬ìŠ¤ìµìŠ¤í”„ë ˆìŠ¤','GSë”í”„ë ˆì‹œ',
                                                    'ë†í˜‘í•˜ë‚˜ë¡œë§ˆíŠ¸','ì´ˆë¡ë§ˆì„','ì‹ìì¬ì™•ë„ë§¤ë§ˆíŠ¸','ê³ í–¥ëœ¨ë½','ì´ë§ˆíŠ¸ì—ë¸Œë¦¬ë°ì´'] },
    { id:'life', label:'ìƒí™œÂ·ê°€ì „', icon:'ğŸ”Œ', keywords:[] },
    { id:'fashion', label:'íŒ¨ì…˜Â·ë·°í‹°', icon:'ğŸ‘—', keywords:[] },
    { id:'dessert', label:'ì œê³¼Â·ë””ì €íŠ¸', icon:'ğŸ°', keywords:[] },
    { id:'food', label:'ì™¸ì‹', icon:'ğŸ½ï¸', keywords:[] },
    { id:'hotel', label:'í˜¸í…”Â·ë¦¬ì¡°íŠ¸', icon:'ğŸ¨', keywords:[] },
    { id:'gstation', label:'ì£¼ìœ Â·ì¶©ì „', icon:'â›½', keywords:[] },
    { id:'movie', label:'ì˜í™”Â·ë„ì„œ', icon:'ğŸ¬', keywords:[] },
    { id:'travel', label:'ë ˆì €Â·ì—¬í–‰', icon:'ğŸ§³', keywords:[] }
  ];

  // ì¹´í…Œê³ ë¦¬ ì½”ë“œ(ê²€ìƒ‰ íš¨ìœ¨ â†‘)
  const BRAND_CATEGORY = {
    cstore:   'CS2', // í¸ì˜ì 
    cafe:     'CE7', // ì¹´í˜
    dstore:   'MT1', // ëŒ€í˜•ë§ˆíŠ¸/ë°±í™”ì /ì‡¼í•‘ëª° ë“±
    mart:     'MT1', // ë§ˆíŠ¸Â·ìŠˆí¼
    life:     'MT1', // ìƒí™œÂ·ê°€ì „
    fashion:  'MT1', // íŒ¨ì…˜Â·ë·°í‹°
    dessert:  'FD6', // ìŒì‹ì (ì œê³¼/ë””ì €íŠ¸ í¬í•¨)
    food:     'FD6', // ìŒì‹ì 
    hotel:    'AD5', // ìˆ™ë°•
    gstation: 'OL7', // ì£¼ìœ ì†Œ/ì¶©ì „
    movie:    'CT1', // ë¬¸í™”ì‹œì„¤
    travel:   'AT4'  // ê´€ê´‘ëª…ì†Œ
  };

  // =========================
  // State
  // =========================
  let map, ps, clusterer, infowindow;
  let allMarkers = [];     // í˜„ì¬ í™œì„± ì¹´í…Œê³ ë¦¬ì˜ ë§ˆì»¤(í´ëŸ¬ìŠ¤í„° ëŒ€ìƒ)
  let searchMarkers = [];  // ì¼ë°˜ í‚¤ì›Œë“œ ê²€ìƒ‰ ë§ˆì»¤(ì„ì‹œ)
  let debounceTimer = null;
  let isSearchMode = false;
  const activeBrands = new Set();   // í•­ìƒ 1ê°œë§Œ ë³´ê´€

  // ë‚´ ìœ„ì¹˜ í‘œì‹œ ê´€ë ¨
  let meOverlay = null;
  let meCircle  = null;
  let geoWatchId = null;
  let centerOnFirstFix = false;

  // =========================
  // Utils
  // =========================
  const $  = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
  const esc = (s='') => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));
  function toast(msg){
    const el = $('#toast'); if(!el) return;
    el.textContent = msg; el.classList.add('show');
    clearTimeout(el._t); el._t = setTimeout(()=> el.classList.remove('show'), 1800);
  }

  // Quota guard (ê°„ë‹¨)
  const QUOTA = { tripped:false, until:0, recentErrors:[], windowMs:30000, tripAfter:3, coolDownMs:10*60*1000 };
  const now = ()=> Date.now();
  function purgeOldErrors(){ const edge = now()-QUOTA.windowMs; QUOTA.recentErrors = QUOTA.recentErrors.filter(t=>t>=edge);}
  function recordSuccess(){ QUOTA.recentErrors=[]; if(QUOTA.tripped && now()>=QUOTA.until) clearQuotaLock(); }
  function recordError(){ purgeOldErrors(); QUOTA.recentErrors.push(now()); if(QUOTA.recentErrors.length>=QUOTA.tripAfter) tripQuotaLock(); }
  function tripQuotaLock(){ QUOTA.tripped=true; QUOTA.until=now()+QUOTA.coolDownMs; showQuotaBanner(); }
  function clearQuotaLock(){ QUOTA.tripped=false; QUOTA.until=0; QUOTA.recentErrors=[]; hideQuotaBanner(); }
  function isQuotaLocked(){ if(!QUOTA.tripped) return false; if(now()>=QUOTA.until){ clearQuotaLock(); return false;} return true; }
  function showQuotaBanner(){ const el=$('#quota-banner'); if(el) el.hidden=false; }
  function hideQuotaBanner(){ const el=$('#quota-banner'); if(el) el.hidden=true; }
  document.addEventListener('click', e=>{ if(e.target && e.target.id==='quota-retry'){ clearQuotaLock(); scanInView(); } });

  // ì´ë¦„ í‚¤ì›Œë“œë¡œ ë¸Œëœë“œ íŒì •
  function brandOf(place){
    const name = (place.place_name||'').toLowerCase();
    for(const b of APPLE_BRANDS){
      if((b.keywords||[]).some(k => name.includes(String(k).toLowerCase()))) return b;
    }
    return null;
  }

  function buildPopupHTML(place, br, isApple=true){
    const addr  = place.road_address_name || place.address_name || '';
    const tel   = place.phone || '';
    const url   = place.place_url || '';
    const parts = [];
    parts.push(`<div class="title">${esc(place.place_name||'ìƒí˜¸ëª…')}</div>`);
    if(addr) parts.push(`<div class="row">ì£¼ì†Œ: ${esc(addr)}</div>`);
    if(tel)  parts.push(`<div class="row">ì „í™”: <a href="tel:${esc(tel)}">${esc(tel)}</a></div>`);
    parts.push(`<div class="row">ì• í”Œí˜ì´: <b>${isApple ? 'ì§€ì›' : 'ë¯¸í™•ì¸(ì¼ë°˜ ê²€ìƒ‰)'}</b></div>`);
    if(br) parts.push(`<div class="row">ë¶„ë¥˜: ${esc(br.label)}</div>`);
    if(url)  parts.push(`<div class="row"><a href="${esc(url)}" target="_blank" rel="noopener">ìƒì„¸ ë³´ê¸°</a></div>`);
    return `<div class="popup">${parts.join('')}</div>`;
  }

  function createMarker(place, br){
    const pos = new kakao.maps.LatLng(+place.y, +place.x);
    const marker = new kakao.maps.Marker({ position: pos, title: place.place_name });
    kakao.maps.event.addListener(marker, 'click', ()=>{
      infowindow.setContent(buildPopupHTML(place, br, true));
      infowindow.open(map, marker);
    });
    marker.__brand = br;
    marker.__place = place;
    return marker;
  }

  function setMarkersToCluster(markers){
    if (clusterer && typeof clusterer.clear === 'function') clusterer.clear();
    else if (clusterer){ clusterer.setMap(null); clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter:true, minLevel:6 }); }
    clusterer.addMarkers(markers);
  }

  function clearSearchMarkers(){
    searchMarkers.forEach(m => m.setMap(null));
    searchMarkers = [];
    isSearchMode = false;
  }

  function filterMarkersByText(q){
    const qq = (q||'').trim().toLowerCase();
    const filtered = !qq ? allMarkers : allMarkers.filter(m=>{
      const p = m.__place;
      const hay = `${p.place_name||''} ${p.road_address_name||''} ${p.address_name||''} ${p.phone||''}`.toLowerCase();
      return hay.includes(qq);
    });
    setMarkersToCluster(filtered);
    return filtered.length;
  }

  function openIssueWith(lat, lng){
    const base = `https://github.com/${encodeURIComponent(CFG.OWNER)}/${encodeURIComponent(CFG.REPO)}/issues/new`;
    const params = new URLSearchParams();
    params.set('title', '[Add] Apple Pay Merchant');
    params.set('labels', CFG.ISSUE_LABEL);
    const body = [
      '**ìƒí˜¸ëª…**\n',
      '**ì¹´í…Œê³ ë¦¬**\nconv / cafe / resto / mart / bakery / pharmacy / transport / other\n',
      '**ìœ„ë„/ê²½ë„**\n', `lat: ${lat}\nlon: ${lng}\n`,
      '**ì• í”Œí˜ì´** (í•´ë‹¹ì— ì²´í¬)\n', '- [ ] Contactless\n- [ ] In-App\n- [ ] Express\n',
      '**ë¹„ê³ /ì¶œì²˜(ì„ íƒ)**\n'
    ].join('\n');
    params.set('body', body);
    window.open(`${base}?${params.toString()}`, '_blank');
  }

  // =========================
  // ë‚´ ìœ„ì¹˜
  // =========================
  function updateMyLocation(lat, lng, accuracy){
    const ll = new kakao.maps.LatLng(lat, lng);
    const acc = Number.isFinite(accuracy) ? accuracy : 30;
    const radius = Math.min(Math.max(acc, 10), 150);
    const showCircle = acc <= 200;

    if(!meOverlay){
      meOverlay = new kakao.maps.CustomOverlay({
        map,
        position: ll,
        yAnchor: 0.5,
        zIndex: 3,
        content: '<div class="me-dot pulse"></div>'
      });
    }else meOverlay.setPosition(ll);

    if(!meCircle){
      meCircle = new kakao.maps.Circle({
        map: showCircle ? map : null,
        center: ll,
        radius,
        strokeWeight: 1,
        strokeColor: '#2563eb',
        strokeOpacity: 0.35,
        strokeStyle: 'solid',
        fillColor: '#3b82f6',
        fillOpacity: 0.10
      });
    }else{
      meCircle.setOptions({ center: ll, radius });
      meCircle.setMap(showCircle ? map : null);
    }
  }

  function stopGeolocWatch(){ if(geoWatchId!=null){ navigator.geolocation.clearWatch(geoWatchId); geoWatchId=null; } }
  function startGeolocWatch(centerOnce=false){
    if(!navigator.geolocation){ toast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”'); return; }
    centerOnFirstFix = !!centerOnce;
    stopGeolocWatch();
    geoWatchId = navigator.geolocation.watchPosition(pos=>{
      const { latitude:lat, longitude:lng, accuracy } = pos.coords;
      updateMyLocation(lat, lng, accuracy);
      if(centerOnFirstFix){
        centerOnFirstFix = false;
        map.setCenter(new kakao.maps.LatLng(lat, lng));
        map.setLevel(4);
        clearSearchMarkers();
        scanInView();
      }
    }, ()=> toast('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”'), { enableHighAccuracy:true, timeout:15000, maximumAge:10000 });
  }

  // =========================
  // Kakao Places helpers
  // =========================
  function categorySearchOnce(groupCode, bounds, page=1){
    return new Promise((resolve,reject)=>{
      if (isQuotaLocked()) return resolve({ data:[] });
      ps.categorySearch(groupCode, (data, status)=>{
        if(status === kakao.maps.services.Status.OK){ recordSuccess(); resolve({ data }); }
        else if(status === kakao.maps.services.Status.ZERO_RESULT){ recordSuccess(); resolve({ data:[] }); }
        else { recordError(); showQuotaBanner(); reject(new Error('Places error: '+status)); }
      }, { bounds, page });
    });
  }
  async function searchCategoryInBounds(groupCode, bounds){
    const results = [];
    for(let page=1; page<=CFG.MAX_PAGES; page++){
      try{
        const { data } = await categorySearchOnce(groupCode, bounds, page);
        results.push(...data);
        if(data.length < 15) break;
      }catch(e){ break; }
    }
    return results;
  }

  // =========================
  // ìŠ¤ìº”: **í™œì„± ì¹´í…Œê³ ë¦¬ 1ê°œë§Œ** í˜¸ì¶œ
  // =========================
  async function scanInView(){
    if(!map) return;
    if(isSearchMode) return;
    if(map.getLevel() > 7){ toast('ì§€ë„ë¥¼ ì¡°ê¸ˆ ë” í™•ëŒ€í•´ ì£¼ì„¸ìš”'); return; }
    if(isQuotaLocked()){ showQuotaBanner(); toast('API ì œí•œ ì¤‘: ì´ë¯¸ ë¶ˆëŸ¬ì˜¨ ê²°ê³¼ë§Œ ì´ìš© ê°€ëŠ¥'); return; }

    const brandId = [...activeBrands][0];
    if(!brandId){ toast('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }

    toast('ê°€ë§¹ì  ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
    const bounds = map.getBounds();
    const code = BRAND_CATEGORY[brandId];
    const raw = await searchCategoryInBounds(code, bounds);

    const uniq = new Map();
    for(const p of raw){
      const lat = +p.y, lng = +p.x;
      if(!isFinite(lat) || !isFinite(lng)) continue;

      const contains = (typeof bounds.contains === 'function')
        ? bounds.contains(new kakao.maps.LatLng(lat, lng))
        : (typeof bounds.contain === 'function' ? bounds.contain(new kakao.maps.LatLng(lat, lng)) : true);
      if(!contains) continue;

      const br = brandOf(p);
      // í™œì„± ì¹´í…Œê³ ë¦¬ì™€ ë¸Œëœë“œê°€ ì¼ì¹˜í•˜ëŠ” ê²°ê³¼ë§Œ í‘œì‹œ(êµì°¨ ë§¤ì¹­ ì°¨ë‹¨)
      if(!br || br.id !== brandId) continue;

      if(!uniq.has(p.id)) uniq.set(p.id, { place: p, br });
    }

    clearSearchMarkers();
    const rows = Array.from(uniq.values());
    allMarkers = rows.map(({ place, br }) => createMarker(place, br));
    setMarkersToCluster(allMarkers);
    toast(`í‘œì‹œë¨: ${allMarkers.length}ê³³`);
  }

  function scheduleScan(){ clearTimeout(debounceTimer); debounceTimer = setTimeout(scanInView, CFG.DEBOUNCE_MS); }

  // =========================
  // ê²€ìƒ‰ ë™ì‘ (ì¹´í…Œê³ ë¦¬ì™€ ë¬´ê´€: ì¼ë°˜ í‚¤ì›Œë“œ ê²€ìƒ‰)
  // =========================
  function keywordSearchOnce(keyword, opts={}, page=1){
    return new Promise((resolve,reject)=>{
      if (isQuotaLocked()) return resolve({ data:[] });
      ps.keywordSearch(keyword, (data, status)=>{
        if(status === kakao.maps.services.Status.OK){ recordSuccess(); resolve({ data }); }
        else if(status === kakao.maps.services.Status.ZERO_RESULT){ recordSuccess(); resolve({ data:[] }); }
        else { recordError(); showQuotaBanner(); reject(new Error('Places error: '+status)); }
      }, { ...opts, page });
    });
  }
  async function keywordSearchPaged(keyword, opts={}){
    const results = [];
    for(let page=1; page<=CFG.MAX_PAGES; page++){
      try{
        const { data } = await keywordSearchOnce(keyword, opts, page);
        results.push(...data);
        if(data.length < 15) break;
      }catch(e){ break; }
    }
    return results;
  }

  async function runSearch(){
    const q = ($('#search').value || '').trim();

    const localCount = filterMarkersByText(q);
    clearSearchMarkers();
    if(localCount > 0){ toast(`í‘œì‹œë¨: ${localCount}ê³³`); return; }

    if(!q){ toast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }

    toast('ê²€ìƒ‰ ì¤‘â€¦ (í™”ë©´ ë‚´)');
    const bounds = map.getBounds();
    let results = await keywordSearchPaged(q, { bounds });

    if(results.length === 0){
      toast('ê²€ìƒ‰ ì¤‘â€¦ (ì „êµ­)');
      results = await keywordSearchPaged(q);
    }
    if(results.length === 0){ toast('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }

    isSearchMode = true;
    clearSearchMarkers();
    const b = new kakao.maps.LatLngBounds();
    searchMarkers = results.map(p=>{
      const ll = new kakao.maps.LatLng(+p.y, +p.x);
      b.extend(ll);
      const m = new kakao.maps.Marker({ position: ll, title: p.place_name });
      kakao.maps.event.addListener(m, 'click', ()=>{
        infowindow.setContent(buildPopupHTML(p, null, false));
        infowindow.open(map, m);
      });
      m.setMap(map);
      return m;
    });
    map.setBounds(b);
    toast(`ê²€ìƒ‰ ê²°ê³¼: ${results.length}ê³³`);
  }

  // =========================
  // ë‹¨ì¼ ì„ íƒ ì¹© ì œì–´
  // =========================
  function setActiveCategory(id){
    // UI ë™ê¸°í™”: í•´ë‹¹ ì¹©ë§Œ active/checked
    $$('.chipbar .chip').forEach(ch=>{
      const on = (ch.dataset.brand === id);
      ch.classList.toggle('active', on);
      const inp = ch.querySelector('input');
      if(inp){ inp.checked = on; }
    });
    // ìƒíƒœ: í•­ìƒ 1ê°œë§Œ ìœ ì§€
    activeBrands.clear();
    activeBrands.add(id);
    clearSearchMarkers();
    scanInView();
  }

  function wireChipsSingleSelect(){
    // ì…ë ¥ ê¸°ë³¸ ë™ì‘ ë§‰ê³  ë¼ë²¨ ì „ì²´ë¥¼ í´ë¦­ ì˜ì—­ìœ¼ë¡œ ì‚¬ìš©
    $$('.chipbar .chip').forEach(ch=>{
      const id = ch.dataset.brand;
      const input = ch.querySelector('input');
      if(input){
        input.addEventListener('click', e => e.preventDefault());
      }
      ch.addEventListener('click', ()=> setActiveCategory(id));
      ch.setAttribute('role','radio');
      ch.setAttribute('aria-checked', ch.classList.contains('active') ? 'true' : 'false');
      const obs = new MutationObserver(()=>{
        ch.setAttribute('aria-checked', ch.classList.contains('active') ? 'true' : 'false');
      });
      obs.observe(ch, { attributes:true, attributeFilter:['class'] });
    });

    // ì´ˆê¸° í•œ ê°œë§Œ ì„ íƒ ë³´ì¥(ì²« ë²ˆì§¸ activeê°€ ì—†ìœ¼ë©´ ì²« ì¹©)
    const firstActive = $$('.chipbar .chip').find(c=>c.classList.contains('active')) || $$('.chipbar .chip')[0];
    setActiveCategory(firstActive.dataset.brand);
  }

  // =========================
  // Init
  // =========================
  function init(){
    map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(CFG.CENTER.lat, CFG.CENTER.lng),
      level: CFG.INIT_LEVEL
    });
    ps = new kakao.maps.services.Places(map);
    infowindow = new kakao.maps.InfoWindow({ zIndex: 2 });
    clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter:true, minLevel:6 });

    kakao.maps.event.addListener(map, 'idle', scheduleScan);

    // ì¹© ë‹¨ì¼ ì„ íƒ ëª¨ë“œ ì„¸íŒ…
    wireChipsSingleSelect();

    // 1íšŒ í˜„ì¬ ìœ„ì¹˜ë¡œ ì„¼í„° ì´ë™ + ìŠ¤ìº”
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const { latitude, longitude, accuracy } = pos.coords;
        map.setCenter(new kakao.maps.LatLng(latitude, longitude));
        map.setLevel(4);
        updateMyLocation(latitude, longitude, accuracy);
        scanInView();
      }, ()=> scanInView(), { enableHighAccuracy:true, timeout:8000, maximumAge:30000 });
      startGeolocWatch(false);
    }else{
      scanInView();
    }

    // ë²„íŠ¼ë“¤
    $('#btn-geoloc').addEventListener('click', ()=> startGeolocWatch(true));
    $('#btn-scan').addEventListener('click', ()=>{ clearSearchMarkers(); $('#search').value=''; scanInView(); });
    $('#btn-center').addEventListener('click', ()=>{ clearSearchMarkers(); map.setCenter(new kakao.maps.LatLng(CFG.CENTER.lat, CFG.CENTER.lng)); map.setLevel(5); scanInView(); });
    $('#btn-add').addEventListener('click', ()=>{
      toast('ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ë©´ ê¹ƒí—ˆë¸Œ ì´ìŠˆ ì–‘ì‹ì´ ì—´ë¦½ë‹ˆë‹¤');
      const once = kakao.maps.event.addListener(map, 'click', (e)=>{
        openIssueWith(e.latLng.getLat(), e.latLng.getLng());
        kakao.maps.event.removeListener(map, 'click', once);
      });
    });

    // ê²€ìƒ‰
    $('#search-submit').addEventListener('click', runSearch);
    $('#search').addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(); });
  }

  window.addEventListener('DOMContentLoaded', ()=> kakao.maps.load(init));
  </script>
</body>
</html>
