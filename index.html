<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ì• í”Œí˜ì´ ê°€ë§¹ì  ì°¾ê¸°</title>
  <link rel="stylesheet" href="styles.css" />
  <meta name="color-scheme" content="light" />
  <!-- Kakao Maps JS -->
  <script defer src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=417a1b970f5ba6f44fd53958e58f47bb&libraries=services,clusterer&autoload=false"></script>

  <style>
    .quota-banner{position:fixed;z-index:601;left:50%;transform:translateX(-50%);top:calc(env(safe-area-inset-top,0px)+110px);background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:.6rem;padding:.5rem .75rem;box-shadow:0 2px 10px rgba(0,0,0,.06);display:flex;align-items:center;gap:.6rem}
    .quota-banner button{border:1px solid #fecaca;background:#fff;border-radius:999px;padding:.25rem .6rem;cursor:pointer}
    @media (max-width:600px){.quota-banner{top:calc(env(safe-area-inset-top,0px)+128px);left:8px;right:8px;transform:none;justify-content:space-between}}
    #map{min-height:70vh}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar" role="banner">
    <div class="brand">ğŸ—ºï¸</div>
    <div class="search-box" role="search">
      <input id="search" placeholder="ìƒí˜¸/ë¸Œëœë“œ ê²€ìƒ‰ (ì˜ˆ: ë§¥ë„ë‚ ë“œ ì›ì£¼ ë‹¨ê³„ DTì  )" aria-label="ê²€ìƒ‰ì–´" />
      <button id="search-submit" aria-label="ê²€ìƒ‰">ğŸ”</button>
    </div>
    <div class="actions">
      <button id="btn-geoloc" title="ë‚´ ìœ„ì¹˜" aria-label="ë‚´ ìœ„ì¹˜">ğŸ“</button>
      <button id="btn-scan" title="í˜„ì¬ í™”ë©´ ì¬ìŠ¤ìº”" aria-label="í˜„ì¬ í™”ë©´ ì¬ìŠ¤ìº”">ğŸ§­</button>
      <button id="btn-add" title="ê°€ë§¹ì  ì œë³´(GitHub)" aria-label="ê°€ë§¹ì  ì œë³´">â•</button>
      <button id="btn-center" title="ì›ì£¼ í„°ë¯¸ë„ë¡œ" aria-label="ì›ì£¼ í„°ë¯¸ë„ë¡œ">ğŸ¯</button>
    </div>
  </div>

  <!-- ë¸Œëœë“œ í•„í„°(ë‹¨ì¼ ì„ íƒ) -->
  <div class="chipbar" role="group" aria-label="ë¸Œëœë“œ í•„í„°">
    <label class="chip active" data-brand="cstore"><input type="checkbox" checked>ğŸª í¸ì˜ì </label>
    <label class="chip" data-brand="cafe"><input type="checkbox">â˜• ì¹´í˜</label>
    <label class="chip" data-brand="dstore"><input type="checkbox">ğŸ›ï¸ ë°±í™”ì ,ì‡¼í•‘</label>
    <label class="chip" data-brand="mart"><input type="checkbox">ğŸ›’ ë§ˆíŠ¸,ìŠˆí¼</label>
    <label class="chip" data-brand="life"><input type="checkbox">ğŸ”Œ ìƒí™œ,ê°€ì „</label>
    <label class="chip" data-brand="fashion"><input type="checkbox">ğŸ‘— íŒ¨ì…˜,ë·°í‹°</label>
    <label class="chip" data-brand="dessert"><input type="checkbox">ğŸ° ì œê³¼,ë””ì €íŠ¸</label>
    <label class="chip" data-brand="food"><input type="checkbox">ğŸ½ï¸ ì™¸ì‹</label>
    <label class="chip" data-brand="hotel"><input type="checkbox">ğŸ¨ í˜¸í…”,ë¦¬ì¡°íŠ¸</label>
    <label class="chip" data-brand="gstation"><input type="checkbox">â›½ ì£¼ìœ ,ì¶©ì „</label>
    <label class="chip" data-brand="movie"><input type="checkbox">ğŸ¬ ì˜í™”,ë„ì„œ</label>
    <label class="chip" data-brand="travel"><input type="checkbox">ğŸ§³ ë ˆì €,ì—¬í–‰</label>
  </div>

  <!-- ì§€ë„ -->
  <div id="map" role="region" aria-label="Myapplepaymaps"></div>

  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite"></div>

  <!-- Quota ì•ˆë‚´ ë°°ë„ˆ -->
  <div id="quota-banner" class="quota-banner" role="alert" aria-live="assertive" hidden>
    <span>ì¹´ì¹´ì˜¤ ì§€ë„ API ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆì„ ìˆ˜ ìˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</span>
    <button id="quota-retry" type="button">ë‹¤ì‹œ ì‹œë„</button>
  </div>

  <script>
  // =========================
  // Config
  // =========================
  const CFG = {
    OWNER: 'diligencefrozen',
    REPO:  'NFCMAP-KR',
    ISSUE_LABEL: 'add-merchant',
    CENTER: { lat: 37.345040, lng: 127.930825 },
    INIT_LEVEL: 5,
    MAX_PAGES: 3,
    DEBOUNCE_MS: 250,

    // API ì œì–´
    API_INTERVAL_MS: 280,         // ì‹œì‘ ê°„ê²©
    MAX_CONCURRENCY: 2,           // ë™ì‹œì— 2ê°œê¹Œì§€ë§Œ
    CACHE_TTL_MS: 6 * 60 * 1000,  // 6ë¶„ ìºì‹œ
    MOVE_FRACTION: 0.35,
    PAGE_BY_LEVEL: { 1:2, 2:2, 3:2, 4:2, 5:1, 6:1, 7:1 },

    // ë¹ ë¥¸ 1ì°¨ ìŠ¤ìº”(ì¹´í…Œê³ ë¦¬ 1í˜ì´ì§€ë§Œ)
    FAST_FIRST: true,
    FAST_PAGES: 1,
    MIN_QUICK_RESULTS: 8,         // ì´ ì´ìƒì´ë©´ í‚¤ì›Œë“œìŠ¤ìº” ìƒëµ

    // ë¸Œëœë“œ í‚¤ì›Œë“œ ëª¨ë“œ(ë³´ì¶©ìš©)
    USE_BRAND_KEYWORD_MODE: true,
    MAX_KEYWORDS_PER_SCAN: 8
  };

  // ë“±ë¡ëœ ë¸Œëœë“œ(í‘œê¸° ë³€í˜• ì¼ë¶€ ë³´ê°•)
  const APPLE_BRANDS = [
    { id:'cstore', label:'í¸ì˜ì ', icon:'ğŸª', keywords:['GS25','GS 25','ì§€ì—ìŠ¤25','CU','ì”¨ìœ ','ì„¸ë¸ì¼ë ˆë¸','Seven Eleven','ì´ë§ˆíŠ¸24','ë¯¸ë‹ˆìŠ¤í†±','ìŠ¤í† ë¦¬ì›¨ì´','ì”¨ìŠ¤í˜ì´ìŠ¤24'] },
    { id:'cafe', label:'ì¹´í˜', icon:'â˜•', keywords:['ìŠ¤íƒ€ë²…ìŠ¤','Starbucks','íˆ¬ì¸í”Œë ˆì´ìŠ¤','ë¹½ë‹¤ë°©','ë©”ê°€ì»¤í”¼','MEGA COFFEE','ì´ë””ì•¼ì»¤í”¼','ë”ë²¤í‹°','í• ë¦¬ìŠ¤','ê³µì°¨','ì»¤í”¼ë¹ˆ','ì—”ì œë¦¬ë„ˆìŠ¤','í´ë°”ì…‹','íŒŒìŠ¤ì¿ ì°Œ','ë¸”ë£¨ë³´í‹€','íƒì•¤íƒìŠ¤','ì•„ë§ˆìŠ¤ë¹ˆ','ì»¤í”¼ë² ì´','í…Œë¼ë¡œì‚¬','ì ë°”ì£¼ìŠ¤','ì»¤í”¼ì•³ì›ìŠ¤','ì¹´í˜ìŠ¤í† ë¦¬ì›¨ì´','ì•„í‹°ì œ','ëŒ„ì‹±ì»µ','íŒ€í™€íŠ¼','ì»´í¬ì¦ˆì»¤í”¼','ì¹´í˜ê¼¼ë§ˆ','í•˜ì´ì˜¤ì»¤í”¼','ì¹´í˜ë´„ë´„'] },
    { id:'dstore', label:'ë°±í™”ì ,ì‡¼í•‘', icon:'ğŸ›ï¸', keywords:['ë¡¯ë°ë°±í™”ì ','ë¡¯ë°ì•„ìš¸ë ›','ë¡¯ë°ëª°','ë¡¯ë°ë©´ì„¸ì ','í˜„ëŒ€ë°±í™”ì ','í˜„ëŒ€ì•„ìš¸ë ›','í˜„ëŒ€ë°±í™”ì ë©´ì„¸ì ','AKí”Œë¼ì','íŒŒë¥´ë‚˜ìŠ¤ëª°','ì•„ì´íŒŒí¬ëª°','ì•¨ë¦¬ì›¨ì´','ì‹ ë¼ë©´ì„¸ì ','JDCë©´ì„¸ì ','ìŠ¤íƒ€í•„ë“œ','ê°¤ëŸ¬ë¦¬ì•„','ì‹ ì„¸ê³„ë©´ì„¸ì '] },
    { id:'mart', label:'ë§ˆíŠ¸,ìŠˆí¼', icon:'ğŸ›’', keywords:['ì½”ìŠ¤íŠ¸ì½”','COSTCO','ë¡¯ë°ë§ˆíŠ¸','ë¡¯ë°ìŠˆí¼','í™ˆí”ŒëŸ¬ìŠ¤ë§ˆíŠ¸','í™ˆí”ŒëŸ¬ìŠ¤ìµìŠ¤í”„ë ˆìŠ¤','GSë”í”„ë ˆì‹œ','ë†í˜‘í•˜ë‚˜ë¡œë§ˆíŠ¸','ì´ˆë¡ë§ˆì„','ì‹ìì¬ì™•ë„ë§¤ë§ˆíŠ¸','ê³ í–¥ëœ¨ë½','ì´ë§ˆíŠ¸ì—ë¸Œë¦¬ë°ì´'] },
    { id:'life', label:'ìƒí™œ,ê°€ì „', icon:'ğŸ”Œ', keywords:['ì´ì¼€ì•„','IKEA','ë‹¤ì´ì†Œ','ë¡¯ë°í•˜ì´ë§ˆíŠ¸','LGì „ìë² ìŠ¤íŠ¸ìƒµ','í”„ë¦¬ìŠ¤ë¹„','ì—ì´ìƒµ','ì•„ì´ìŠ¤í† ì–´','ì•„íŠ¸ë°•ìŠ¤','ì˜¤í”¼ìŠ¤ë””í¬','í† ì´ì €ëŸ¬ìŠ¤','í”„ë¦°íŠ¸ì¹´í˜','ì—ì´ìŠ¤ì¹¨ëŒ€'] },
    { id:'fashion', label:'íŒ¨ì…˜,ë·°í‹°', icon:'ğŸ‘—', keywords:['ì˜¬ë¦¬ë¸Œì˜','ë¬´ì‹ ì‚¬ìŠ¤íƒ ë‹¤ë“œ','ì´ë‹ˆìŠ¤í”„ë¦¬','ABCë§ˆíŠ¸','ì— í”Œë ˆì´ê·¸ë¼ìš´ë“œ'] },
    { id:'dessert', label:'ì œê³¼,ë””ì €íŠ¸', icon:'ğŸ°', keywords:['íŒŒë¦¬ë°”ê²Œëœ¨','íŒŒë¦¬í¬ë¼ìƒ','ëšœë ˆì¥¬ë¥´','ë°°ìŠ¤í‚¨ë¼ë¹ˆìŠ¤','ë˜í‚¨','í¬ë¦¬ìŠ¤í”¼í¬ë¦¼ë„ë„›','ë””ì €íŠ¸39','íŠ¸ë¦¬í•€','ë¹šì€','ë³µí˜¸ë‘','ì‡¼ì½œë¼íŒ”ë ˆíŠ¸'] },
    { id:'food', label:'ì™¸ì‹', icon:'ğŸ½ï¸', keywords:['ë¡¯ë°ë¦¬ì•„','ë§¥ë„ë‚ ë“œ','KFC','ì‰ì´í¬ì‰‘','ë¼ê·¸ë¦´ë¦¬ì•„','í”¼ê·¸ì¸ë”ê°€ë“ ','ê¹€ê°€ë„¤','ë´‰ì¶”ì°œë‹­','ìŠ¤íŠ¸ë¦¿','í€¸ì¦ˆíŒŒí¬','ë¼ëœ°ë¦¬ì—','ì—ê·¸ìŠ¬ëŸ¿','ì‹œí‹°ë¸ë¦¬','ë¦¬ë‚˜ìŠ¤','VIPS','ì œì¼ì œë©´ì†Œ','ë”í”Œë ˆì´ìŠ¤','ë”ìŠ¤í…Œì´í¬í•˜ìš°ìŠ¤','ë”í…Œì´ìŠ¤í„°ë¸”','íŒŒíŒŒì´ìŠ¤','ì¿ ì°¨ë¼','ì•„ì›ƒë°±ìŠ¤í…Œì´í¬í•˜ìš°ìŠ¤','í”Œë ˆì´íŒ…','ì´ì‚­í† ìŠ¤íŠ¸','í•œì†¥ë„ì‹œë½','íŒŒì´ë¸Œê°€ì´ì¦ˆ'] },
    { id:'hotel', label:'í˜¸í…”,ë¦¬ì¡°íŠ¸', icon:'ğŸ¨', keywords:['í•´ë¹„ì¹˜í˜¸í…”ì•¤ë“œë¦¬ì¡°íŠ¸'] },
    { id:'gstation', label:'ì£¼ìœ ,ì¶©ì „', icon:'â›½', keywords:['GSì¹¼í…ìŠ¤'] },
    { id:'movie', label:'ì˜í™”,ë„ì„œ', icon:'ğŸ¬', keywords:['ë©”ê°€ë°•ìŠ¤','MEGABOX','ë¡¯ë°ì‹œë„¤ë§ˆ'] },
    { id:'travel', label:'ë ˆì €,ì—¬í–‰', icon:'ğŸ§³', keywords:['ì„œìš¸ëœë“œ'] }
  ];

  // ì¹´í…Œê³ ë¦¬ ì½”ë“œ
  const BRAND_CATEGORY = {
    cstore:'CS2', cafe:'CE7', dstore:'MT1', mart:'MT1', life:'MT1',
    fashion:'MT1', dessert:'FD6', food:'FD6', hotel:'AD5',
    gstation:'OL7', movie:'CT1', travel:'AT4'
  };
  
  // ====== ë¸Œëœë“œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ëª¨ë“œ ======
  const BRAND_WHITELIST_MODE = true;  // â† ì´ê±¸ trueë¡œ ì¼œë©´, ê° ì¹´í…Œê³ ë¦¬ëŠ” ì—¬ê¸° ì§€ì •í•œ ë¸Œëœë“œë§Œ ê²€ìƒ‰
  const BRAND_WHITELIST = {

    // í¸ì˜ì 
    cstore: ['GS25','GS 25','ì§€ì—ìŠ¤25','CU','ì”¨ìœ ','ì„¸ë¸ì¼ë ˆë¸','Seven Eleven','ì´ë§ˆíŠ¸24','ë¯¸ë‹ˆìŠ¤í†±','ìŠ¤í† ë¦¬ì›¨ì´','ì”¨ìŠ¤í˜ì´ìŠ¤24'],
    // ì¹´í˜
    cafe: ['ìŠ¤íƒ€ë²…ìŠ¤','Starbucks','íˆ¬ì¸í”Œë ˆì´ìŠ¤','ë¹½ë‹¤ë°©','ë©”ê°€ì»¤í”¼','MEGA COFFEE','ì´ë””ì•¼ì»¤í”¼','ë”ë²¤í‹°','í• ë¦¬ìŠ¤','ê³µì°¨','ì»¤í”¼ë¹ˆ','ì—”ì œë¦¬ë„ˆìŠ¤','í´ë°”ì…‹','íŒŒìŠ¤ì¿ ì°Œ','ë¸”ë£¨ë³´í‹€','íƒì•¤íƒìŠ¤','ì•„ë§ˆìŠ¤ë¹ˆ','ì»¤í”¼ë² ì´','í…Œë¼ë¡œì‚¬','ì ë°”ì£¼ìŠ¤','ì»¤í”¼ì•³ì›ìŠ¤','ì¹´í˜ìŠ¤í† ë¦¬ì›¨ì´','ì•„í‹°ì œ','ëŒ„ì‹±ì»µ','íŒ€í™€íŠ¼','ì»´í¬ì¦ˆì»¤í”¼','ì¹´í˜ê¼¼ë§ˆ','í•˜ì´ì˜¤ì»¤í”¼','ì¹´í˜ë´„ë´„'],
    // ë°±í™”ì ,ì‡¼í•‘
    dstore: ['ë¡¯ë°ë°±í™”ì ','ë¡¯ë°ì•„ìš¸ë ›','ë¡¯ë°ëª°','ë¡¯ë°ë©´ì„¸ì ','í˜„ëŒ€ë°±í™”ì ','í˜„ëŒ€ì•„ìš¸ë ›','í˜„ëŒ€ë°±í™”ì ë©´ì„¸ì ','AKí”Œë¼ì','íŒŒë¥´ë‚˜ìŠ¤ëª°','ì•„ì´íŒŒí¬ëª°','ì•¨ë¦¬ì›¨ì´','ì‹ ë¼ë©´ì„¸ì ','JDCë©´ì„¸ì ','ìŠ¤íƒ€í•„ë“œ','ê°¤ëŸ¬ë¦¬ì•„','ì‹ ì„¸ê³„ë©´ì„¸ì ']
    // ë§ˆíŠ¸,ìŠˆí¼
    mart: ['ì½”ìŠ¤íŠ¸ì½”','COSTCO','ë¡¯ë°ë§ˆíŠ¸','ë¡¯ë°ìŠˆí¼','í™ˆí”ŒëŸ¬ìŠ¤ë§ˆíŠ¸','í™ˆí”ŒëŸ¬ìŠ¤ìµìŠ¤í”„ë ˆìŠ¤','GSë”í”„ë ˆì‹œ','ë†í˜‘í•˜ë‚˜ë¡œë§ˆíŠ¸','ì´ˆë¡ë§ˆì„','ì‹ìì¬ì™•ë„ë§¤ë§ˆíŠ¸','ê³ í–¥ëœ¨ë½','ì´ë§ˆíŠ¸ì—ë¸Œë¦¬ë°ì´']
    // ìƒí™œ,ê°€ì „
    life: ['ì´ì¼€ì•„','IKEA','ë‹¤ì´ì†Œ','ë¡¯ë°í•˜ì´ë§ˆíŠ¸','LGì „ìë² ìŠ¤íŠ¸ìƒµ','í”„ë¦¬ìŠ¤ë¹„','ì—ì´ìƒµ','ì•„ì´ìŠ¤í† ì–´','ì•„íŠ¸ë°•ìŠ¤','ì˜¤í”¼ìŠ¤ë””í¬','í† ì´ì €ëŸ¬ìŠ¤','í”„ë¦°íŠ¸ì¹´í˜','ì—ì´ìŠ¤ì¹¨ëŒ€']
    // íŒ¨ì…˜,ë·°í‹°
    fashion: ['ì˜¬ë¦¬ë¸Œì˜','ë¬´ì‹ ì‚¬ìŠ¤íƒ ë‹¤ë“œ','ì´ë‹ˆìŠ¤í”„ë¦¬','ABCë§ˆíŠ¸','ì— í”Œë ˆì´ê·¸ë¼ìš´ë“œ']
    // ì œê³¼,ë””ì €íŠ¸
    dessert: ['íŒŒë¦¬ë°”ê²Œëœ¨','íŒŒë¦¬í¬ë¼ìƒ','ëšœë ˆì¥¬ë¥´','ë°°ìŠ¤í‚¨ë¼ë¹ˆìŠ¤','ë˜í‚¨','í¬ë¦¬ìŠ¤í”¼í¬ë¦¼ë„ë„›','ë””ì €íŠ¸39','íŠ¸ë¦¬í•€','ë¹šì€','ë³µí˜¸ë‘','ì‡¼ì½œë¼íŒ”ë ˆíŠ¸']
    // ì™¸ì‹
    food: ['ë¡¯ë°ë¦¬ì•„','ë§¥ë„ë‚ ë“œ','KFC','ì‰ì´í¬ì‰‘','ë¼ê·¸ë¦´ë¦¬ì•„','í”¼ê·¸ì¸ë”ê°€ë“ ','ê¹€ê°€ë„¤','ë´‰ì¶”ì°œë‹­','ìŠ¤íŠ¸ë¦¿','í€¸ì¦ˆíŒŒí¬','ë¼ëœ°ë¦¬ì—','ì—ê·¸ìŠ¬ëŸ¿','ì‹œí‹°ë¸ë¦¬','ë¦¬ë‚˜ìŠ¤','VIPS','ì œì¼ì œë©´ì†Œ','ë”í”Œë ˆì´ìŠ¤','ë”ìŠ¤í…Œì´í¬í•˜ìš°ìŠ¤','ë”í…Œì´ìŠ¤í„°ë¸”','íŒŒíŒŒì´ìŠ¤','ì¿ ì°¨ë¼','ì•„ì›ƒë°±ìŠ¤í…Œì´í¬í•˜ìš°ìŠ¤','í”Œë ˆì´íŒ…','ì´ì‚­í† ìŠ¤íŠ¸','í•œì†¥ë„ì‹œë½','íŒŒì´ë¸Œê°€ì´ì¦ˆ']
    // í˜¸í…”,ë¦¬ì¡°íŠ¸
    hotel: ['í•´ë¹„ì¹˜í˜¸í…”ì•¤ë“œë¦¬ì¡°íŠ¸']
    // ì£¼ìœ ,ì¶©ì „
    gstation: ['GSì¹¼í…ìŠ¤']
    // ì˜í™”,ë„ì„œ
    movie: ['ë©”ê°€ë°•ìŠ¤','MEGABOX','ë¡¯ë°ì‹œë„¤ë§ˆ']
    // ë ˆì €,ì—¬í–‰
    travel: ['ì„œìš¸ëœë“œ']
};

// í‚¤ì›Œë“œ ëª©ë¡ì„ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¡œ ì¢í˜€ì£¼ëŠ” ë„ìš°ë¯¸
function norm(s){ return (s||'').toLowerCase().replace(/\s+/g,'').trim(); } // íŒŒì¼ ë‚´ì— ì´ë¯¸ normì´ ìˆìœ¼ë©´ ì´ í•¨ìˆ˜ëŠ” ìƒëµ
function getKeywordsForBrandId(brandId){
  const b = (APPLE_BRANDS||[]).find(x=>x.id===brandId);
  if(!b) return [];
  const base = Array.isArray(b.keywords) ? b.keywords : [];
  if(!BRAND_WHITELIST_MODE) return base;

  const wl = BRAND_WHITELIST[brandId];
  if(!wl || wl.length===0) return base; // í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì—†ìœ¼ë©´ ê¸°ì¡´ ì „ì²´ í‚¤ì›Œë“œ

  // í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ë“¤ì–´ìˆëŠ” ê²ƒë§Œ ë‚¨ê¹€ (í‘œê¸° ë³€í˜• ë°©ì–´)
  return base.filter(k => {
    const nk = norm(k);
    return wl.some(w => {
      const nw = norm(w);
      return nk.includes(nw) || nw.includes(nk);
    });
  });
}


  // =========================
  // State
  // =========================
  let map, ps, clusterer, infowindow;
  let allMarkers = [];
  let searchMarkers = [];
  let debounceTimer = null;
  let isSearchMode = false;
  const activeBrands = new Set(['cstore']);
  let meOverlay = null, meCircle = null, geoWatchId = null, centerOnFirstFix = false;

  // ----- ìš”ì²­ ìŠ¤ì¼€ì¤„ëŸ¬ (ê°„ê²© + ì†ŒëŸ‰ ë³‘ë ¬) -----
  const _q = { queue: [], inflight: 0, lastAt: 0 };
  function enqueueKakao(maker){
    return new Promise((resolve, reject)=>{
      _q.queue.push({ maker, resolve, reject });
      _pump();
    });
  }
  function _pump(){
    if (!_q.queue.length) return;
    if (_q.inflight >= CFG.MAX_CONCURRENCY) return;

    const wait = Math.max(0, CFG.API_INTERVAL_MS - (Date.now() - _q.lastAt));
    setTimeout(()=>{
      if (!_q.queue.length) return;
      const job = _q.queue.shift();
      _q.inflight++; _q.lastAt = Date.now();
      job.maker()
        .then(job.resolve)
        .catch(job.reject)
        .finally(()=>{ _q.inflight--; _pump(); });
    }, wait);

    // ì—¬ìœ ê°€ ìˆìœ¼ë©´ ë‹¤ìŒ ê²ƒë„ ì˜ˆì•½
    if (_q.inflight + 1 < CFG.MAX_CONCURRENCY) {
      setTimeout(_pump, wait + 5);
    }
  }

  // ----- cache (center+level+tag) -----
  const CACHE = new Map();
  function _cacheKey(tag){
    const c = map.getCenter(), lvl = map.getLevel();
    return `${tag}|${lvl}|${c.getLat().toFixed(2)},${c.getLng().toFixed(2)}`;
  }
  function cacheLoad(tag){ const v = CACHE.get(_cacheKey(tag)); return v && (Date.now()-v.ts) < CFG.CACHE_TTL_MS ? v.places : null; }
  function cacheSave(tag, places){ CACHE.set(_cacheKey(tag), { ts: Date.now(), places }); }
  function pagesForLevel(){ return CFG.PAGE_BY_LEVEL[map.getLevel()] ?? 1; }

  // ----- ì´ë™ ì„ê³„ì¹˜ -----
  let lastScanState = null; // {lat,lng,level}
  function movedEnough(){
    if (!lastScanState) return true;
    const b = map.getBounds(), c = map.getCenter(), level = map.getLevel();
    const latSpan = b.getNorthEast().getLat() - b.getSouthWest().getLat();
    const lngSpan = b.getNorthEast().getLng() - b.getSouthWest().getLng();
    const dLat = Math.abs(c.getLat() - lastScanState.lat);
    const dLng = Math.abs(c.getLng() - lastScanState.lng);
    return level !== lastScanState.level ||
           dLat > latSpan * CFG.MOVE_FRACTION || dLng > lngSpan * CFG.MOVE_FRACTION;
  }

  // =========================
  // Utils
  // =========================
  const $  = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
  const esc = (s='') => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])) ;
  function norm(s=''){ return String(s).toLowerCase().replace(/\s|Â·|ã†|ãƒ»|\.|,|\/|-/g,'').replace(/ì |ì§€ì |ì„¼í„°|ëª°|íƒ€ì›Œ|ì—­|ë³¸ì |ì§€í•˜/g,''); }
  function toast(msg){ const el=$('#toast'); if(!el) return; el.textContent=msg; el.classList.add('show'); clearTimeout(el._t); el._t=setTimeout(()=>el.classList.remove('show'),1200); }

  // Quota guard
  const QUOTA = { tripped:false, until:0, recentErrors:[], windowMs:30000, tripAfter:3, coolDownMs:600000 };
  const now = ()=>Date.now();
  const purgeOldErrors = ()=>{ const edge=now()-QUOTA.windowMs; QUOTA.recentErrors=QUOTA.recentErrors.filter(t=>t>=edge); };
  const recordSuccess = ()=>{ QUOTA.recentErrors=[]; if(QUOTA.tripped && now()>=QUOTA.until) clearQuotaLock(); };
  const recordError = ()=>{ purgeOldErrors(); QUOTA.recentErrors.push(now()); if(QUOTA.recentErrors.length>=QUOTA.tripAfter) tripQuotaLock(); };
  const tripQuotaLock = ()=>{ QUOTA.tripped=true; QUOTA.until=now()+QUOTA.coolDownMs; showQuotaBanner(); };
  const clearQuotaLock = ()=>{ QUOTA.tripped=false; QUOTA.until=0; QUOTA.recentErrors=[]; hideQuotaBanner(); };
  const isQuotaLocked = ()=> QUOTA.tripped && now() < QUOTA.until;
  function showQuotaBanner(){ const el=$('#quota-banner'); if(el) el.hidden=false; }
  function hideQuotaBanner(){ const el=$('#quota-banner'); if(el) el.hidden=true; }
  document.addEventListener('click', e=>{ if(e.target && e.target.id==='quota-retry'){ clearQuotaLock(); scanInView(true); } });

  // === Kakao Places helpers ===
  function categorySearchOnce(groupCode,bounds,page=1){
    return enqueueKakao(()=> new Promise((resolve,reject)=>{
      if (isQuotaLocked()) return resolve({ data:[] });
      ps.categorySearch(groupCode,(data,status)=>{
        if(status===kakao.maps.services.Status.OK){ recordSuccess(); resolve({data}); }
        else if(status===kakao.maps.services.Status.ZERO_RESULT){ recordSuccess(); resolve({data:[]}); }
        else{ recordError(); showQuotaBanner(); reject(new Error('Places error: '+status)); }
      }, { bounds, page });
    }));
  }
  function keywordSearchOnce(keyword,opts={},page=1){
    return enqueueKakao(()=> new Promise((resolve,reject)=>{
      if (isQuotaLocked()) return resolve({ data:[] });
      ps.keywordSearch(keyword,(data,status)=>{
        if(status===kakao.maps.services.Status.OK){ recordSuccess(); resolve({data}); }
        else if(status===kakao.maps.services.Status.ZERO_RESULT){ recordSuccess(); resolve({data:[]}); }
        else{ recordError(); showQuotaBanner(); reject(new Error('Places error: '+status)); }
      }, { ...opts, page });
    }));
  }

  // --- ë¹ ë¥¸ 1ì°¨: ì¹´í…Œê³ ë¦¬ 1í˜ì´ì§€ ---
  async function searchCategoryFast(activeId, bounds){
    const code = BRAND_CATEGORY[activeId]; if(!code) return [];
    const tag='fast:'+code;
    const cached=cacheLoad(tag); if(cached) return cached;
    const results=[];
    const pages = CFG.FAST_PAGES;
    for(let p=1; p<=pages; p++){
      try{ const {data}=await categorySearchOnce(code,bounds,p); results.push(...data); if(data.length<15) break; }
      catch(e){ break; }
    }
    cacheSave(tag,results); return results;
  }

  // --- ì¼ë°˜ ì¹´í…Œê³ ë¦¬(í˜ì´ì§€ ê°€ë³€) ---
  async function searchCategoryInBounds(activeId,bounds){
    const code = BRAND_CATEGORY[activeId]; if(!code) return [];
    const tag='cat:'+code;
    const cached=cacheLoad(tag); if(cached) return cached;
    const results=[]; const maxPages=pagesForLevel();
    for(let p=1; p<=maxPages; p++){
      try{ const {data}=await categorySearchOnce(code,bounds,p); results.push(...data); if(data.length<15) break; }
      catch(e){ break; }
    }
    cacheSave(tag,results); return results;
  }

  // --- ë¸Œëœë“œ í‚¤ì›Œë“œ ìŠ¤ìº”(ë³´ì¶©ìš©) ---
  async function searchBrandsInBounds(activeId,bounds){
    const tag='kw:'+activeId;
    const cached=cacheLoad(tag); if(cached) return cached;

    const b = APPLE_BRANDS.find(x=>x.id===activeId);
    if(!b) return [];
    const kwList = (b.keywords||[]).slice(0, CFG.MAX_KEYWORDS_PER_SCAN);
    const results=[]; const maxPages=pagesForLevel();

    for(const kw of kwList){
      for(let page=1; page<=maxPages; page++){
        try{
          const {data}=await keywordSearchOnce(kw,{ bounds },page);
          results.push(...data);
          if(data.length<15) break;
        }catch(e){ break; }
      }
    }
    cacheSave(tag,results);
    return results;
  }

  // --- í•„í„°/í‘œì‹œ ìœ í‹¸ ---
  const containsBounds = (b,lat,lng)=>{
    return typeof b.contains==='function'
      ? b.contains(new kakao.maps.LatLng(lat,lng))
      : (typeof b.contain==='function' ? b.contain(new kakao.maps.LatLng(lat,lng)) : true);
  };
  function pickBrandForPlace(place, activeId){
    const b = APPLE_BRANDS.find(x=>x.id===activeId);
    if(!b) return null;
    const nameN = norm(place.place_name||'');
    return (b.keywords||[]).some(k => nameN.includes(norm(k))) ? b : null;
  }
  function buildPopupHTML(place, br, isApple=true){
    const addr=place.road_address_name||place.address_name||'';
    const tel=place.phone||''; const url=place.place_url||'';
    const parts=[];
    parts.push(`<div class="title">${esc(place.place_name||'ìƒí˜¸ëª…')}</div>`);
    if(addr) parts.push(`<div class="row">ì£¼ì†Œ: ${esc(addr)}</div>`);
    if(tel) parts.push(`<div class="row">ì „í™”: <a href="tel:${esc(tel)}">${esc(tel)}</a></div>`);
    parts.push(`<div class="row">ì• í”Œí˜ì´: <b>${isApple?'ì§€ì›':'ë¯¸í™•ì¸(ì¼ë°˜ ê²€ìƒ‰)'}</b></div>`);
    if(br) parts.push(`<div class="row">ë¶„ë¥˜: ${esc(br.label)}</div>`);
    if(url) parts.push(`<div class="row"><a href="${esc(url)}" target="_blank" rel="noopener">ìƒì„¸ ë³´ê¸°</a></div>`);
    return `<div class="popup">${parts.join('')}</div>`;
  }
  function createMarker(place, br){
    const pos=new kakao.maps.LatLng(+place.y,+place.x);
    const marker=new kakao.maps.Marker({ position: pos, title: place.place_name });
    kakao.maps.event.addListener(marker,'click',()=>{
      infowindow.setContent(buildPopupHTML(place, br, true));
      infowindow.open(map, marker);
    });
    marker.__brand=br; marker.__place=place;
    return marker;
  }
  function setMarkersToCluster(markers){
    if (clusterer && typeof clusterer.clear==='function') clusterer.clear();
    else if (clusterer){ clusterer.setMap(null); clusterer=new kakao.maps.MarkerClusterer({ map, averageCenter:true, minLevel:6 }); }
    clusterer.addMarkers(markers);
  }
  function clearSearchMarkers(){ searchMarkers.forEach(m=>m.setMap(null)); searchMarkers=[]; isSearchMode=false; }
  function filterMarkersByText(q){
    const qq=(q||'').trim().toLowerCase();
    const filtered=!qq?allMarkers:allMarkers.filter(m=>{
      const p=m.__place; const hay=`${p.place_name||''} ${p.road_address_name||''} ${p.address_name||''} ${p.phone||''}`.toLowerCase();
      return hay.includes(qq);
    });
    setMarkersToCluster(filtered);
    return filtered.length;
  }

  // =========================
  // ë‹¨ì¼ ì¹´í…Œê³ ë¦¬ ìŠ¤ìº” (ë¹ ë¥¸ 1ì°¨ â†’ ì¶©ë¶„í•˜ë©´ ë, ë¶€ì¡±í•˜ë©´ ë³´ì¶©)
  // =========================
  function getActiveBrandId(){ return Array.from(activeBrands)[0]; }

  async function scanInView(force=false){
    if(!map || isSearchMode) return;
    if(map.getLevel()>7){ toast('ì§€ë„ë¥¼ ì¡°ê¸ˆ ë” í™•ëŒ€í•´ ì£¼ì„¸ìš”'); return; }
    if (isQuotaLocked()){ showQuotaBanner(); toast('API ì œí•œ ì¤‘'); return; }
    if (!force && !movedEnough()) return;

    const activeId=getActiveBrandId();
    const activeBrand = APPLE_BRANDS.find(b=>b.id===activeId);
    if(!activeBrand){ toast('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }

    const bounds=map.getBounds();
    toast(`${activeBrand.label} ì°¾ëŠ” ì¤‘â€¦`);

    // 1) ì´ˆê³ ì†: ì¹´í…Œê³ ë¦¬ 1í˜ì´ì§€ë§Œ ë°›ì•„ì„œ ë¸Œëœë“œ í•„í„°
    let pooledFast = CFG.FAST_FIRST ? await searchCategoryFast(activeId, bounds) : [];
    let rows = [];
    if (pooledFast.length){
      const uniqFast=new Map();
      for(const p of pooledFast){
        const lat=+p.y, lng=+p.x;
        if(!isFinite(lat)||!isFinite(lng) || !containsBounds(bounds,lat,lng)) continue;
        const br = pickBrandForPlace(p,activeId);
        if(!br) continue;
        if(!uniqFast.has(p.id)) uniqFast.set(p.id,{ place:p, br });
      }
      rows = Array.from(uniqFast.values());
      // ì¦‰ì‹œ í‘œì‹œ
      allMarkers = rows.map(({place,br})=>createMarker(place,br));
      setMarkersToCluster(allMarkers);
      toast(`í‘œì‹œë¨: ${allMarkers.length}ê³³`);
      await new Promise(r=>setTimeout(r,0)); // UI ê°±ì‹  ì–‘ë³´
    }

    // 2) ì¶©ë¶„í•˜ë©´ ì¢…ë£Œ, ì•„ë‹ˆë©´ ë³´ì¶© ìŠ¤ìº”
    if (rows.length < CFG.MIN_QUICK_RESULTS){
      const pooled = CFG.USE_BRAND_KEYWORD_MODE
        ? await searchBrandsInBounds(activeId, bounds)
        : await searchCategoryInBounds(activeId, bounds);

      const uniq=new Map();
      for(const p of pooled){
        const lat=+p.y, lng=+p.x;
        if(!isFinite(lat)||!isFinite(lng) || !containsBounds(bounds,lat,lng)) continue;
        const br = CFG.USE_BRAND_KEYWORD_MODE ? activeBrand : pickBrandForPlace(p,activeId);
        if(!br) continue;
        if(!uniq.has(p.id)) uniq.set(p.id,{ place:p, br });
      }
      rows = Array.from(uniq.values());
      allMarkers = rows.map(({place,br})=>createMarker(place,br));
      setMarkersToCluster(allMarkers);
      toast(`í‘œì‹œë¨: ${allMarkers.length}ê³³`);
    }

    // ìŠ¤ìº” ìƒíƒœ ì €ì¥
    const cc=map.getCenter();
    lastScanState={ lat: cc.getLat(), lng: cc.getLng(), level: map.getLevel() };
  }

  function scheduleScan(){
    clearTimeout(debounceTimer);
    debounceTimer=setTimeout(()=>{ if (movedEnough()) scanInView(false); }, CFG.DEBOUNCE_MS);
  }

  // =========================
  // ê²€ìƒ‰ (í˜„ì¬ í‘œì¶œ ì¤‘ ìš°ì„  í•„í„° â†’ í•„ìš” ì‹œ í‚¤ì›Œë“œ ê²€ìƒ‰)
  // =========================
  async function runSearch(){
    const q=($('#search').value||'').trim();
    const localCount=filterMarkersByText(q);
    clearSearchMarkers();
    if(localCount>0){ toast(`í‘œì‹œë¨: ${localCount}ê³³`); return; }
    if(!q){ toast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }

    toast('ê²€ìƒ‰ ì¤‘â€¦ (í™”ë©´ ë‚´)');
    const bounds=map.getBounds();
    let results=[];
    for(let page=1; page<=CFG.MAX_PAGES; page++){
      try{
        const {data}=await keywordSearchOnce(q,{ bounds },page);
        results.push(...data);
        if(data.length<15) break;
      }catch(e){ break; }
    }
    if(results.length===0){ toast('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }

    isSearchMode=true; clearSearchMarkers();
    const b=new kakao.maps.LatLngBounds();
    searchMarkers=results.map(p=>{
      const ll=new kakao.maps.LatLng(+p.y,+p.x); b.extend(ll);
      const m=new kakao.maps.Marker({ position: ll, title: p.place_name });
      kakao.maps.event.addListener(m,'click',()=>{
        infowindow.setContent(buildPopupHTML(p,null,false)); infowindow.open(map,m);
      });
      m.setMap(map); return m;
    });
    map.setBounds(b);
    toast(`ê²€ìƒ‰ ê²°ê³¼: ${results.length}ê³³`);
  }

  // =========================
  // ë‹¨ì¼ ì„ íƒ ìœ ë„ ìœ í‹¸
  // =========================
  function setActiveCategory(id){
    activeBrands.clear();
    activeBrands.add(id);

    $$('.chipbar .chip').forEach(ch=>{
      const checked = ch.dataset.brand === id;
      ch.classList.toggle('active', checked);
      const input = ch.querySelector('input[type="checkbox"]');
      if(input) input.checked = checked;
    });

    clearSearchMarkers();
    $('#search').value='';
    lastScanState=null;
    scanInView(true);
  }

  // =========================
  // Init
  // =========================
  function init(){
    map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(CFG.CENTER.lat, CFG.CENTER.lng),
      level: CFG.INIT_LEVEL
    });

    ps = new kakao.maps.services.Places(map);
    infowindow = new kakao.maps.InfoWindow({ zIndex: 2 });
    clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter:true, minLevel:6 });

    // idle ëŒ€ì‹  ë¶„ë¦¬: ê³¼ë„í•œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
    kakao.maps.event.addListener(map, 'dragend', scheduleScan);
    kakao.maps.event.addListener(map, 'zoom_changed', scheduleScan);

    // ê¸°ë³¸ì€ í¸ì˜ì 
    setActiveCategory('cstore');

    // ìœ„ì¹˜
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const { latitude, longitude, accuracy } = pos.coords;
        map.setCenter(new kakao.maps.LatLng(latitude, longitude));
        map.setLevel(4);
        updateMyLocation(latitude, longitude, accuracy);
        scanInView(true);
      }, ()=> scanInView(true), { enableHighAccuracy:true, timeout:8000, maximumAge:30000 });

      startGeolocWatch(false);
    }else{
      scanInView(true);
    }

    // ë²„íŠ¼
    $('#btn-geoloc').addEventListener('click', ()=> startGeolocWatch(true));
    $('#btn-scan').addEventListener('click', ()=>{ clearSearchMarkers(); $('#search').value=''; scanInView(true); });
    $('#btn-center').addEventListener('click', ()=>{ clearSearchMarkers(); map.setCenter(new kakao.maps.LatLng(CFG.CENTER.lat, CFG.CENTER.lng)); map.setLevel(5); scanInView(true); });
    $('#btn-add').addEventListener('click', ()=>{
      toast('ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ë©´ ê¹ƒí—ˆë¸Œ ì´ìŠˆ ì–‘ì‹ì´ ì—´ë¦½ë‹ˆë‹¤');
      const once=kakao.maps.event.addListener(map,'click',(e)=>{
        openIssueWith(e.latLng.getLat(), e.latLng.getLng());
        kakao.maps.event.removeListener(map,'click',once);
      });
    });

    // ê²€ìƒ‰
    $('#search-submit').addEventListener('click', runSearch);
    $('#search').addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(); });

    // ì¹© = ë¼ë””ì˜¤ì²˜ëŸ¼
    $$('.chipbar .chip').forEach(ch=>{
      const id=ch.dataset.brand;
      const input=ch.querySelector('input[type="checkbox"]');
      input.addEventListener('change', ()=>{
        if(input.checked){ setActiveCategory(id); toast(`${APPLE_BRANDS.find(b=>b.id===id)?.label} ì¹´í…Œê³ ë¦¬ë¡œ ì „í™˜`); }
        else { input.checked=true; }
      });
      ch.addEventListener('click', (e)=>{
        if(e.target.tagName!=='INPUT'){ input.checked=true; input.dispatchEvent(new Event('change',{bubbles:true})); }
      });
    });
  }

  // ë‚´ ìœ„ì¹˜
  function updateMyLocation(lat,lng,accuracy){
    const ll=new kakao.maps.LatLng(lat,lng);
    const acc=Number.isFinite(accuracy)?accuracy:30;
    const radius=Math.min(Math.max(acc,10),150);
    const showCircle=acc<=200;
    if(!meOverlay){
      meOverlay=new kakao.maps.CustomOverlay({ map, position: ll, yAnchor: .5, zIndex:3, content:'<div class="me-dot pulse"></div>' });
    }else{ meOverlay.setPosition(ll); }
    if(!meCircle){
      meCircle=new kakao.maps.Circle({ map: showCircle?map:null, center: ll, radius, strokeWeight:1, strokeColor:'#2563eb', strokeOpacity:.35, strokeStyle:'solid', fillColor:'#3b82f6', fillOpacity:.10 });
    }else{
      meCircle.setOptions({ center: ll, radius }); meCircle.setMap(showCircle?map:null);
    }
  }
  function stopGeolocWatch(){ if(geoWatchId!=null){ navigator.geolocation.clearWatch(geoWatchId); geoWatchId=null; } }
  function startGeolocWatch(centerOnce=false){
    if(!navigator.geolocation){ toast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”'); return; }
    centerOnFirstFix=!!centerOnce; stopGeolocWatch();
    geoWatchId=navigator.geolocation.watchPosition(pos=>{
      const { latitude:lat, longitude:lng, accuracy }=pos.coords;
      updateMyLocation(lat,lng,accuracy);
      if(centerOnFirstFix){
        centerOnFirstFix=false;
        map.setCenter(new kakao.maps.LatLng(lat,lng)); map.setLevel(4);
        clearSearchMarkers(); scanInView(true);
      }
    }, ()=>{ toast('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”'); }, { enableHighAccuracy:true, timeout:15000, maximumAge:10000 });
  }

  window.addEventListener('DOMContentLoaded', ()=> kakao.maps.load(init));
  </script>
</body>
</html>
